\documentclass[a4paper,UKenglish]{lipics-v2016}
% for section-numbered lemmas etc., use "numberwithinsect"
 
\usepackage{microtype}%if unwanted, comment out or use option "draft"

%\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\bibliographystyle{plainurl}

% Author macros::begin %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{A Normalizing Computation Rule for Propositional Extensionality in Higher-Order Minimal Logic
%\footnote{This work was partially supported by someone.}
}
\titlerunning{Strong Normalization for Propositional Extensionality in Minimal Logic} %optional, in case that the title is too long; the running title should fit into the top page column

%% Please provide for each author the \author and \affil macro, even when authors have the same affiliation, i.e. for each author there needs to be the  \author and \affil macros
\author[1]{Robin Adams}
\author[1]{Marc Bezem}
\author[3]{Thierry Coquand}
\affil[1]{Universitetet i Bergen, Institutt for Informatikk, Postboks 7800, N-5020 BERGEN, Norway \\
  \texttt{\{robin.adams,bezem\}@ii.uib.no}}
\affil[3]{Chalmers tekniska högskola, Data- och informationsteknik, 412 96 Göteborg, Sweden \\
  \texttt{coquand@chalmers.se}}
\authorrunning{R. Adams, M. Bezem and T. Coquand} %mandatory. First: Use abbreviated first/middle names. Second (only in severe cases): Use first author plus 'et. al.'

\Copyright{Robin Adams and Marc Bezem and Thierry Coquand}%mandatory, please use full first names. LIPIcs license is "CC-BY";  http://creativecommons.org/licenses/by/3.0/

\subjclass{Dummy classification -- please refer to \url{http://www.acm.org/about/class/ccs98-html}}% mandatory: Please choose ACM 1998 classifications from http://www.acm.org/about/class/ccs98-html . E.g., cite as "F.1.1 Models of Computation". 
\keywords{Dummy keyword -- please provide 1--5 keywords}% mandatory: Please provide 1-5 keywords
% Author macros::end %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Acces}
\EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016}
\EventAcronym{CVIT}
\EventYear{2016}
\EventDate{December 24--27, 2016}
\EventLocation{Little Whinging, United Kingdom}
\EventLogo{}
\SeriesVolume{42}
\ArticleNo{23}
% Editor-only macros::end %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{suffix}
\newcommand*{\eqdef}{\mathrel{\smash{\stackrel{\text{def}}{=}}}}
\newcommand*{\isotoid}{\ensuremath{\mathrm{isotoid}}}
\newcommand*{\reff}[1]{\ensuremath{\mathrm{ref} \left( {#1} \right)}}
\newcommand*{\univ}[4]{\ensuremath{\mathrm{univ}_{{#1}, {#2}} \left({#3} , {#4} \right)}}
\WithSuffix\newcommand\univ*[2]{\ensuremath{\mathsf{univ} \left( {#1} , {#2} \right)}}
\newcommand*{\triplelambda}{\ensuremath{\lambda \!\! \lambda \!\! \lambda}}
\newcommand*{\vald}{\ensuremath{\vdash \mathrm{valid}}}
\newcommand*{\dom}{\ensuremath{\operatorname{dom}}}
\newcommand{\Path}[3]{\ensuremath{\mathrm{Path} \, {#1} \, {#2} \, {#3}}}

\theoremstyle{plain}
\newtheorem{proposition}[theorem]{Proposition}

\usepackage{proof}

\begin{document}

\maketitle

\begin{abstract}
The univalence axiom expresses the principle of extensionality for dependent types theory. However, if we simply add the univalence axiom to type theory, then we lose the property of canonicity --- that every term computes to a normal form. A computation becomes `stuck' when it reaches the point that it needs to evaluate a proof term that is an application of the univalence axiom. So we wish to find a way to compute with the univalence axiom. While this problem has been solved with the formulation of cubical type theory, where the computations are expressed using a nominal extension of lambda-calculus, it may be interesting to explore alternative solutions, which do not require such an extension.

As a first step, we present here a system of higher-order minimal propositional logic, with a universe $\Omega$ of propositions closed under implication. We add a type $M =_A N$ for any terms $M$, $N$ of type $A$, and two ways to prove an equality: reflexivity, and \emph{propositional extensionality} --- logically equivalent propositions are equal.  This system allows for some definitional equalities that are not present in cubical type theory, namely that transport along the trivial path is identity.

We present a head reduction relation for this system, and prove that the system satisfies canonicity: every closed typable term head-reduces to a canonical form.  This work has been formalised in Agda.
 \end{abstract}

%\item Fill out the \verb+\subjclass+ and \verb+\keywords+ macros. For the \verb+\subjclass+, please refer to the ACM classification at \url{http://www.acm.org/about/class/ccs98-html}.
%\item Take care of suitable linebreaks and pagebreaks. No overfull \verb+\hboxes+ should occur in the warnings log.

\section{Introduction}

The rules of deduction of a type theory are traditionally justified by a \emph{meaning explanation} \cite{ML:ITT}, in which to know that a given term has a given type is to know that it computes to a \emph{canonical object} of that type.  A necessary condition for such a meaning explanation is that the type theory should have the following syntactic properties:
\begin{itemize}
\item \textbf{Confluence} --- The reduction relation should be confluent.
\item \textbf{Normalization} --- Every well-typed term should reduce to a normal form.
\item Every closed normal form of type $A$ is a canonical object of type $A$.
\end{itemize}
From these three properties, we have:
\begin{itemize}
\item \textbf{Canonicity} --- Every term of type $A$ reduces to a unique canonical object of type $A$.
\end{itemize}

It is desirable to have, in addition, \emph{strong normalization}, so that we know that we are free to choose whatever reduction strategy we please.

The \emph{univalence axiom} of Homotopy Type theory (HoTT) \cite{hottbook} breaks the property of canonicity.  It postulates a
constant
\[ \isotoid : A \simeq B \rightarrow A = B \]
that is an inverse to the canonical function $A = B \rightarrow A \simeq B$.  When a computation reaches a point
where we eliminate a path (proof of equality) formed by $\isotoid$, it gets 'stuck'.

As possible solutions to this problem, we may try to do with a weaker property than canonicity, such as \emph{propositional canonicity}.
We may attempt to prove that every closed term of type $\mathbb{N}$ is \emph{propositionally} equal to a numeral, as conjectured by Voevodsky.  Or we may attempt to change the definition of equality to make $\isotoid$ definable\cite{Polonsky14a}, or extend the type theory with higher dimensions (e.g. Cubical Type Theory\cite{cchm:cubical}).

We could also try a more conservative approach, and simply attempt to find a reduction relation for a type theory involving $\isotoid$ that satisfies
all three of the properties above.  There seems to be no reason \emph{a priori} to believe this is not possible, but it is difficult to do because
the full Homotopy Type Theory is a complex and interdependent system.  We can tackle the problem by adding univalence to a much simpler system, finding
a well-behaved reduction relation, then doing the same for more and more complex systems, gradually approaching the full strength of HoTT.

In this paper, we present a system we call $\lambda o e$, or predicative higher-order minimal logic.  It is a type theory with two universes: the universe $\Omega$
of \emph{propositions}, and the universe of \emph{types}.  The propositions are closed under $\supset$ (implication) and include $\bot$ (falsehood), and an equality proposition $M =_A N$ for
any type $A$ and terms $M : A$ and $N : A$.  The types include $\Omega$ itself and are closed under $\rightarrow$ (non-dependent function type).

There are two canonical forms for proofs of $M =_\Omega N$.  For any term $M : \Omega$, we have $\reff{M} : M =_\Omega M$.  We also add univalence for this system, in this form:
if $\delta : \varphi \supset \psi$ and $\epsilon : \psi \supset\varphi$, then $\univ{\varphi}{\psi}{\delta}{\epsilon} : \varphi =_\Omega \psi$.  

We present a deteriministic head reduction relation for this system, and prove that every typable term head reduces to a canonical form.  From this, it follows that the system is consistent.  In the appendix, we present a proof of strong normalization for a different reduction relation.
%confluence (Corollary \ref{cor:confluence}), strong normalization (Corollary \ref{cor:SN}) and canonicity (Corollary \ref{cor:canon}).

For the future, we wish to expand the system with universal quantification, and expand it to a 2-dimensional system (with equations between proofs).

The proofs in this paper have been formalized in Agda.  The formalization is available at \texttt{github.com/radams78/univalence}.

\section{Predicative Higher-Order Minimal Logic with Extensional Equality}

We call the following type theory $\lambda o e$, or \emph{predicative higher-order minimal logic with extensional equality}.  

\subsection{Syntax}

Fix three disjoint, infinite sets of variables, which we shall call \emph{term variables}, \emph{proof variables}
and \emph{path variables}.  We shall use $x$ and $y$ as term variables, $p$ and $q$ as proof variables,
$e$ as a path variable, and $z$ for a variable that may come from any of these three sets.

The syntax of $\lambda o e$ is given by the grammar:

\[
\begin{array}{lrcl}
\text{Type} & A,B,C & ::= & \Omega \mid A \rightarrow B \\
\text{Term} & L,M,N, \phi,\psi,\chi & ::= & x \mid \bot \mid \phi \supset \psi \mid \lambda x:A.M \mid MN \\
\text{Proof} & \delta, \epsilon & ::= & p \mid \lambda p:\phi.\delta \mid \delta \epsilon \mid P^+ \mid P^- \\
\text{Path} & P, Q & ::= & e \mid \reff{M} \mid P \supset^* Q \mid \univ{\phi}{\psi}{P}{Q} \mid \\
& & & \triplelambda e : x =_A y. P \mid P_{MN} Q \\
\text{Context} & \Gamma, \Delta, \Theta & ::= & \langle \rangle \mid \Gamma, x : A \mid \Gamma, p : \phi \mid \Gamma, e : M =_A N \\
\text{Judgement} & \mathbf{J} & ::= & \Gamma \vald \mid \Gamma \vdash M : A \mid \Gamma \vdash \delta : \phi \mid \\
& & & \Gamma \vdash P : M =_A N
\end{array}
\]

In the path $\triplelambda e : x =_A y . P$, the term variables $x$ and $y$ must be distinct.  (We also have $x \not\equiv e \not\equiv y$, thanks to our
stipulation that term variables and path variables are disjoint.)  The term variable $x$ is bound within $M$ in the term $\lambda x:A.M$,
and the proof variable $p$ is bound within $\delta$ in $\lambda p:\phi.\delta$.  The three variables $e$, $x$ and $y$ are bound within $P$ in the path
$\triplelambda e:x =_A y.P$.  We identify terms, proofs and paths up to $\alpha$-conversion.

We shall use the word 'expression' to mean either a type, term, proof, path, or equation (an equation having the form $M =_A N$).  We shall use $r$, $s$, $t$, $S$ and $T$ as metavariables that range over expressions.

Note that we use both Roman letters $M$, $N$ and Greek letters $\phi$, $\psi$, $\chi$ to range over terms.  Intuitively, a term is understood as either a proposition or a function,
and we shall use Greek letters for terms that are intended to be propositions.  Formally, there is no significance to which letter we choose.

Note also that the types of $\lambda o e$ are just the simple types over $\Omega$; therefore, no variable can occur in a type.

The intuition behind the new expressions is as follows (see also the rules of deduction in Figure \ref{fig:lambdaoe}).  For any object $M : A$, there is the trivial path $\reff{M} : M =_A M$.  The constructor $\supset^*$ ensures congruence for $\supset$ --- if $P : \phi =_\Omega \phi'$ and $Q : \psi =_\Omega \psi'$ then $P \supset^* Q : \phi \supset \psi =_\Omega \phi' \supset \psi'$.  The constructor $\mathsf{univ}$ gives univalence for our propositions: if $\delta : \phi \supset \psi$ and $\epsilon : \psi \supset \phi$, then $\univ{\phi}{\psi}{\delta}{\epsilon}$ is a path of type $\phi =_\Omega \psi$.  The constructors $^+$ and $^-$ are the converses: if $P$ is a path of type $\phi =_\Omega \psi$, then $P^+$ is a proof of $\phi \supset \psi$, and $P^-$ is a proof of $\psi \supset \phi$.

The constructor $\triplelambda$ gives functional extensionality.  Let $F$ and $G$ be functions of type $A \rightarrow B$.  If $F x =_B G y$ whenever $x =_A y$, then $F =_{A \rightarrow B} G$.  More formally, if $P$ is a path of type $Fx =_B Gy$ that depends on $x : A$, $y : A$ and $e : x =_A y$, then $\triplelambda e : x =_A y . P$ is a path of type $F =_{A \rightarrow B} G$.

Finally, if $P$ is a path of type $F =_{A \rightarrow B} G$, and $Q$ is a path $M =_A N$, then $P_{MN} Q$ is a path $FM =_B G N$.

\subsection{Path Substitution}

Intuitively, if $N$ and $N'$ are equal then $M[x:=N]$ and $M[x:=N']$ should be equal.  To handle this syntactically,
we introduce a notion of \emph{path substitution}.  If $N$, $M$ and $M'$ are terms, $x$ a term variable, and $P$ a path, then we shall define a path $N \{ x := P : M = M' \}$.  The intention is that, if
$\Gamma \vdash P : M =_A M'$ and $\Gamma, x : A \vdash N : B$ then $\Gamma \vdash N \{ x := P : M = M' \} : N [ x:= M ] =_B N [ x := M' ]$ (see Lemma \ref{lm:pathsub}). 

\begin{definition}[Path Substitution]
Given terms $M_1$, \ldots, $M_n$ and $N_1$, \ldots, $N_n$; paths $P_1$, \ldots, $P_n$; term variables $x_1$, \ldots, $x_n$; and a term $L$, define the path $L \{ x_1 := P_1 : M_1 = N_1 , \ldots, x_n := P_n : M_n = N_n \}$ as follows.
\begin{align*}
x_i \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \} & \eqdef P_i \\
y \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \} & \eqdef \reff{y} \qquad (y \not\equiv x_1, \ldots, x_n) \\
\bot \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \} & \eqdef \reff{\bot} \\
(LL') \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \} \\
\omit\rlap{\qquad \qquad $\eqdef L \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \}_{L' [\vec{x} := \vec{M}] L' [\vec{x} := \vec{N}]} L' \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \}$} \\
(\lambda y:A.L) \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \} & \\
\omit\rlap{\qquad\qquad $\eqdef \triplelambda e : a =_A a' . L \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} , y := e : a = a' \}$} \\
(\phi \supset \psi) \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \} & \eqdef \phi \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \} \supset^* \psi \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \}
\end{align*}
\end{definition}

We shall often omit the endpoints $\vec{M}$ and $\vec{N}$.

\paragraph*{Note}
The case $n = 0$ is permitted, and we shall have that, if $\Gamma \vdash M : A$ then $\Gamma \vdash M \{\} : M =_A M$.  There are thus two paths from a term $M$ to itself: $\reff{M}$ and $M \{\}$.  There are not always equal; for example, $(\lambda x:A.x) \{\} \equiv \triplelambda e : x =_A y. e$, which (after we define the reduction relation) will not be convertible with $\reff{\lambda x:A.x}$.

\begin{lemma}
\[ M \{ \vec{x} := \vec{P} : \vec{M} = \vec{N} \} \equiv M \{ \vec{x} := \vec{P} : \vec{M} = \vec{N}, y := \reff{y} : y = y \} \]
\end{lemma}

\begin{proof}
An easy induction on $M$.
\end{proof}

The following lemma shows how substitution and path substitution interact.

\begin{lemma}[Substitution]
\label{lm:subpathsub}
Let $\vec{x}$ and $\vec{y}$ be a disjoint sequences of variables.  Then
\begin{enumerate}
\item
\label{lm:subpathsubi}
$ \begin{aligned}[t]
& M [ x:= N ] \{ \vec{y} := \vec{P} : \vec{L} = \vec{L'} \} \\
& \equiv M \{ x := N \{ \vec{y} := \vec{P} : \vec{L} = \vec{L'} \} : N [ \vec{y}:= \vec{L} ] = N [ \vec{y} := \vec{L'} ], \vec{y} := \vec{P} : \vec{L} = \vec{L'} \}
\end{aligned} $
\item
\label{lm:subpathsubii}
$ \begin{aligned}[t]
& M \{ \vec{y} := \vec{P} : \vec{L} = \vec{L'} \} [ x := N ] \\
& \equiv M \{ \vec{y} := \vec{P} [x := N] : \vec{L} [x := N] = \vec{L'} [x := N], x := \reff{N} : N = N \}
\end{aligned} $
\end{enumerate}
\end{lemma}

\begin{proof}
An easy induction on $M$ in all cases.
\end{proof}

\paragraph*{Note}
The familiar substitution lemma also holds: $t [\vec{z_1} := \vec{s_1}] [\vec{z_2} := \vec{s_2}] \equiv t [\vec{z_1} := \vec{s_1}[\vec{z_2} := \vec{s_2}], 
\vec{z_2} := \vec{s_2}]$.  We cannot form a lemma about the fourth case, simplifying $M \{ \vec{x} := \vec{P} \} \{ \vec{y} := \vec{Q} \}$, because
$M \{ \vec{x} := \vec{P} \}$ is a path, and path substitution can only be applied to a term.

\begin{definition}
A \emph{path substitution} $\tau$ is a function whose domain is a finite set of term variables,
and which maps each term variable to a path.  Given a path substitution $\tau$ and substitutions $\rho$, $\sigma$
with the same domain $\{ x_1, \ldots, x_n \}$, we write
\[ M \{ \tau : \rho = \sigma \} \text{ for } M \{ x_1 := \tau(x_1) : \rho(x_1) = \sigma(x_1), \ldots, \tau(x_n) : \rho(x_n) = \sigma(x_n) \} \enspace . \]

Given substitutions $\sigma$, $\rho$, $\rho'$ and a path substitution $\tau$, let $\tau \bullet_{\rho, \rho'} \sigma$ be the path substitution defined by
\[ (\tau \bullet_{\rho, \rho'} \sigma)(x) \eqdef \sigma(x)\{ \tau : \rho = \rho' \} \]
\end{definition}

\begin{lemma}
\label{lm:pathsubsub}
$M[\sigma]\{ \tau : \rho = \rho' \} \equiv
M\{ \tau \bullet_{\rho \rho'} \sigma : \rho \circ \sigma = \rho' \circ \sigma \}$
\end{lemma}

\begin{proof}
An easy induction on $M$.
\end{proof}

\subsection{Rules of Deduction}

The rules of deduction of $\lambda o e$ are given in Figure \ref{fig:lambdaoe}.  In these rules, $\simeq_\beta$ denotes the usual relation of $\beta$-convertibility between terms.

\newcommand{\RvarT}{\ensuremath(\mathsf{varT})}
\begin{figure}
\paragraph*{Contexts}
\[ \infer{\langle \rangle \vald}{} \qquad
\infer{\Gamma, x : A \vald}{\Gamma \vald} \qquad 
\infer{\Gamma, p : \phi \vald}{\Gamma \vdash \phi : \Omega} \qquad
\infer{\Gamma, e : M =_A N \vald}{\Gamma \vdash M : A \quad \Gamma \vdash N : A} \]
\[ (\mathrm{var}_T) \quad \infer[(x : A \in \Gamma)]{\Gamma \vdash x : A}{\Gamma \vald} \qquad
(\mathrm{var}_P) \quad \infer[(p : \phi \in \Gamma)]{\Gamma \vdash p : \phi}{\Gamma \vald} \]
\[ (\mathrm{var}_E) \quad \infer[(e : M =_A N \in \Gamma)]{\Gamma \vdash e : M =_A N}{\Gamma \vald} \]

\paragraph*{Terms}
\[ (\bot) \quad \infer{\Gamma \vdash \bot : \Omega}{\Gamma \vald} \qquad
(\supset) \quad \infer{\Gamma \vdash \phi \supset \psi : \Omega}{\Gamma \vdash \phi : \Omega \quad \Gamma \vdash \psi : \Omega} \]
\[ (\mathrm{app}_T) \quad \infer{\Gamma \vdash M N : B} {\Gamma \vdash M : A \rightarrow B \quad \Gamma \vdash N : A} \qquad
(\lambda_T) \quad \infer{\Gamma \vdash \lambda x:A.M : A \rightarrow B}{\Gamma, x : A \vdash M : B} \]

\paragraph*{Proofs}
\[ (\mathrm{app}_P) \quad \infer{\Gamma \vdash \delta \epsilon : \psi} {\Gamma \vdash \delta : \phi \supset \psi \quad \Gamma \vdash \epsilon : \phi} \qquad
(\lambda_P) \quad \infer{\Gamma \vdash \lambda p : \phi . \delta : \phi \supset \psi}{\Gamma, p : \phi \vdash \delta : \psi} \]
\[ (\mathrm{conv}_P) \quad \infer[(\phi \simeq_\beta \psi)]{\Gamma \vdash \delta : \psi}{\Gamma \vdash \delta : \phi \quad \Gamma \vdash \psi : \Omega} \]

\paragraph*{Paths}
\[ (\mathrm{ref}) \quad \infer{\Gamma \vdash \reff{M} : M =_A M}{\Gamma \vdash M : A}
\qquad
(\supset^*) \quad \infer{\Gamma \vdash P \supset^* Q : \phi \supset \psi =_\Omega \phi' \supset \psi'}{\Gamma \vdash P : \phi =_\Omega \phi' \quad \Gamma \vdash Q : \psi =_\Omega \psi'} \]
\[ (\mathrm{univ}) \quad \infer{\Gamma \vdash \univ{\phi}{\psi}{\delta}{\epsilon} : \phi =_\Omega \psi}{\Gamma \vdash \delta : \phi \supset \psi \quad \Gamma \vdash \epsilon : \psi \supset \phi} 
\qquad
(\mathrm{plus}) \quad \infer{\Gamma \vdash P^+ : \phi \supset \psi}{\Gamma \vdash P : \phi =_\Omega \psi}
\qquad
(\mathrm{minus}) \quad \infer{\Gamma \vdash P^- : \psi \supset \phi}{\Gamma \vdash P : \psi =_\Omega \psi} \]
\[ (\triplelambda) \quad \infer{\Gamma \vdash \triplelambda e : x =_A y . P : M =_{A \rightarrow B} N}
  {\begin{array}{c}
     \Gamma, x : A, y : A, e : x =_A y \vdash P : M x =_B N y \\
     \Gamma \vdash M : A \rightarrow B \quad
\Gamma \vdash N : A \rightarrow B
     \end{array}} \]
\[ (\mathrm{app}_E) \quad \infer{\Gamma \vdash P_{NN'}Q : MN =_B M' N'}{\Gamma \vdash P : M =_{A \rightarrow B} M' \quad \Gamma \vdash Q : N =_A N' \quad \Gamma \vdash N : A \quad \Gamma \vdash N' : A} \]
\[ (\mathrm{conv}_E) \quad \infer[(M \simeq_\beta M', N \simeq_\beta N')]{\Gamma \vdash P : M' =_A N'}{\Gamma \vdash P : M =_A N \quad \Gamma \vdash M' : A \quad \Gamma \vdash N' : A} \]
\caption{Rules of Deduction of $\lambda oe$}
\label{fig:lambdaoe}
\end{figure}

\subsection{Metatheorems}

\label{section:meta}

In the lemmas that follow, the letter $\mathcal{J}$ stands for any of the expressions that may occur to the right of the turnstile in a judgement, i.e.~$\mathrm{valid}$, $M : A$, $\delta : \phi$, or $P : M =_A N$.

\begin{lemma}[Context Validity]
Every derivation of $\Gamma, \Delta \vdash \mathcal{J}$ has a subderivation of $\Gamma \vald$.
\end{lemma}

\begin{proof}
Induction on derivations.
\end{proof}

\begin{lemma}[Weakening]
If $\Gamma \vdash \mathcal{J}$, $\Gamma \subseteq \Delta$ and $\Delta \vald$ then $\Delta \vdash \mathcal{J}$.
\end{lemma}

\begin{proof}
Induction on derivations.
\end{proof}

\begin{lemma}[Type Validity]
$ $
\begin{enumerate}
\item
If $\Gamma \vdash \delta : \phi$ then $\Gamma \vdash \phi : \Omega$.
\item
If $\Gamma \vdash P : M =_A N$ then $\Gamma \vdash M : A$ and $\Gamma \vdash N : A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Induction on derivations.  The cases where $\delta$ or $P$ is a variable use Context Validity.
\end{proof}

\begin{lemma}[Generation]
$ $
\begin{enumerate}
\item
If $\Gamma \vdash x : A$ then $x : A \in \Gamma$.
\item
If $\Gamma \vdash \bot : A$ then $A \equiv \Omega$.
\item
If $\Gamma \vdash \phi \supset \psi : A$ then $\Gamma \vdash \phi : \Omega$, $\Gamma \vdash \psi : \Omega$ and $A \equiv \Omega$.
\item
If $\Gamma \vdash \lambda x:A.M : B$ then there exists $C$ such that $\Gamma, x : A \vdash M : C$ and $B \equiv A \rightarrow C$.
\item
If $\Gamma \vdash MN : A$ then there exists $B$ such that $\Gamma \vdash M : B \rightarrow A$ and $\Gamma \vdash N : B$.
\item
If $\Gamma \vdash p : \phi$, then there exists $\psi$ such that $p : \psi \in \Gamma$ and $\phi \simeq \psi$.
\item
If $\Gamma \vdash \lambda p:\phi.\delta : \psi$, then there exists $\chi$ such that $\Gamma, p : \phi \vdash \delta : \chi$ and $\psi \simeq \phi \supset \chi$.
\item
If $\Gamma \vdash \delta \epsilon : \phi$ then there exists $\psi$ such that $\Gamma \vdash \delta : \psi \supset \phi$ and $\Gamma \vdash \epsilon : \psi$.
\item
If $\Gamma \vdash e : M =_A N$, then there exist $M'$, $N'$ such that $e : M' =_A N' \in \Gamma$ and $M \simeq M'$, $N \simeq N'$.
\item
If $\Gamma \vdash \reff{M} : N =_A P$, then we have $\Gamma \vdash M : A$ and $M \simeq N \simeq P$.
\item
If $\Gamma \vdash P \supset^* Q : \phi =_A \psi$, then there exist $\phi_1$, $\phi_2$, $\psi_1$, $\psi_2$ such that
$\Gamma \vdash P : \phi_1 =_\Omega \psi_1$, $\Gamma \vdash Q : \phi_2 =_\Omega \psi_2$, $\phi \simeq \phi_1 \supset \psi_1$, $\psi \simeq \phi_2 \supset \psi_2$, and $A \equiv \Omega$.
\item
If $\Gamma \vdash \univ{\phi}{\psi}{P}{Q} : \chi =_A \theta$, then we have $\Gamma \vdash P : \phi \supset \psi$, $\Gamma \vdash Q : \psi \supset \phi$,
$\Gamma \vdash \chi \simeq_\Delta \phi : \Omega$, $\Gamma \vdash \theta \simeq_\Delta \psi : \Omega$ and $A \equiv \Omega$.
\item
If $\Gamma \vdash \triplelambda e : x =_A y. P : M =_B N$ then there exists $C$ such that $\Gamma, x : A, y : A, e : x =_A y \vdash P : M x =_C N y$
and $B \equiv A \rightarrow C$.
\item
If $\Gamma \vdash P_{M M'} Q : N =_A N'$, then there exist $B$, $F$ and $G$ such that $\Gamma \vdash P : F =_{B \rightarrow A} G$, $\Gamma \vdash Q : M =_B M'$, $N \simeq F M$
and $N' \simeq G M'$.
\item
If $\Gamma \vdash P^+ : \phi$, then there exist $\psi$, $\chi$ such that $\Gamma \vdash P : \psi =_\Omega \chi$ and $\phi \simeq (\psi \supset \chi)$.
\item
If $\Gamma \vdash P^- : \phi$, there exist $\psi$, $\chi$ such that $\Gamma \vdash P : \psi =_\Omega \chi$ and $\phi \simeq (\chi \supset \psi)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Induction on derivations.
\end{proof}

\subsubsection{Substitutions}

\begin{definition}
Let $\Gamma$ and $\Delta$ be contexts.  A \emph{substitution from $\Gamma$ to $\Delta$}\footnote{These have also been called \emph{context morphisms}, for example in Hoffman \cite{Hofmann97syntaxand}.  Note however that what we call a substitution from $\Gamma$ to $\Delta$ is what Hoffman calls a context morphism from $\Delta$ to $\Gamma$.}, $\sigma : \Gamma \Rightarrow \Delta$,
is a substitution whose domain is $\dom \Gamma$ such that:
\begin{itemize}
\item
for every term variable $x : A \in \Gamma$, we have $\Delta \vdash \sigma(x) : A$;
\item
for every proof variable $p : \phi \in \Gamma$, we have $\Delta \vdash \sigma(p) : \phi [ \sigma ]$;
\item
for every path variable $e : M =_A N \in \Gamma$, we have $\Delta \vdash \sigma(e) : M [ \sigma ] =_A N [ \sigma ]$.
\end{itemize}
\end{definition}

\begin{lemma}[Well-Typed Substitution]
If $\Gamma \vdash \mathcal{J}$, $\sigma : \Gamma \Rightarrow \Delta$ and $\Delta \vald$, then $\Delta \vdash \mathcal{J} [\sigma]$.
\end{lemma}

\begin{proof}
Induction on derivations.
\end{proof}

\begin{definition}
If $\rho, \sigma : \Gamma \rightarrow \Delta$ and $\tau$ is a path substitution whose domain
is the term variables in $\dom \Gamma$, then we write
$\tau : \sigma = \rho : \Gamma \rightarrow \Delta$ iff, for each variable $x : A \in \Gamma$, we have
$\Delta \vdash \tau(x) : \sigma(x) =_A \rho(x)$.
\end{definition}

\begin{lemma}[Path Substitution]
\label{lm:pathsub}
If $\tau : \sigma = \rho : \Gamma \rightarrow \Delta$ and $\Gamma \vdash M : A$ and $\Delta \vald$,
then $\Delta \vdash M \{ \tau : \sigma = \rho \} : M [ \sigma ] =_A M [ \rho ]$.
\end{lemma}

\begin{proof}
Induction on derivations.
\end{proof}

\begin{lemma}
\label{lm:pathsubcomp}
If $\sigma : \Gamma \rightarrow \Delta$ and $\tau : \rho = \rho' : \Delta \rightarrow \Theta$ then $\tau \bullet_{\rho, \rho'} \sigma : \rho \circ \sigma = \rho' \circ \sigma : \Gamma \rightarrow \Theta$.
\end{lemma}

\begin{proof}
Let $x : A \in \Gamma$.
We have $\Delta \vdash \sigma(x) : A$, hence $\Theta \vdash \sigma(x) \{ \tau : \rho = \rho' \} : \sigma(x) [ \rho ] =_A \sigma(x) [ \rho' ]$.
\end{proof}

\begin{proposition}[Subject Reduction]
If $\Gamma \vdash s : T$ and $s \twoheadrightarrow t$ then $\Gamma \vdash t : T$.
\end{proposition}

\begin{proof}
It is sufficient to prove the case $s \rightarrow t$.  The proof is by a case analysis on $s \rightarrow t$, using the Generation Lemma.
\end{proof}

\subsubsection{Canonicity}

\begin{definition}[Canonical Object]
$ $
\begin{itemize}
\item
The canonical objects $\theta$ of $\Omega$, or \emph{canonical propositions}, are given by the grammar
\[ \theta ::= \bot \mid \theta \supset \theta \]
\item
A canonical object of type $A \rightarrow B$ has the form $\lambda x:A.M$, where
$x : A \vdash M : B$ and $M$ is in normal form.
\end{itemize}
We define the \emph{canonical proofs} of a canonical object $\theta$ of $\Omega$ as follows:
\begin{itemize}
\item
There is no canonical proof of $\bot$.
\item
A canonical proof of $\phi \supset \psi$ has the form $\lambda p : \phi . \delta$, where $p : \phi \vdash \delta : \psi$ and $\delta$ is in normal form.
\end{itemize}
We define the \emph{canonical paths} of an equation $M =_A N$, where $M$ and $N$ are canonical objects of $A$, as follows:
\begin{itemize}
\item
A canonical path of $\phi =_\Omega \psi$ is either $\reff{\phi}$ if $\phi \simeq \psi$, or $\univ{\phi}{\psi}{\delta}{\epsilon}$, where $\delta$ is a canonical
proof of $\phi \supset \psi$ and $\epsilon$ is a canonical proof of $\psi \supset \phi$.
\item
A canonical path of $F =_{A \rightarrow B} G$ is either $\reff{F}$ if $F \simeq G$, or $\triplelambda e:x =_A y.P$ where $x : A, y : A, e : x =_A y \vdash P : Fx =_B Gy$ and $P$ is in normal form.
\end{itemize}
\end{definition}

\section{Head Reduction}

\begin{definition}[Head Reduction]
Define the relation of \emph{head reduction} $\rightarrow$ on the expressions as follows:
\begin{itemize}
\item
$(\lambda x:A.M)N \rightarrow M[x:=N]$.
\item
If $M \rightarrow M'$ then $MN \rightarrow M'N$.
\item
If $\phi \rightarrow \phi'$ and $\psi \rightarrow \psi'$ then $\phi \supset \psi \rightarrow \phi' \supset \psi'$.
\item
$\reff{\phi}^+ \delta \rightarrow \delta$ and $\reff{\phi}^- \delta \rightarrow \delta$.
\item
If $P \rightarrow P'$ and $Q \rightarrow Q'$ then $P \supset^* Q \rightarrow P' \supset^* Q'$.
\item
$\reff{\phi} \supset^* \reff{\psi} \rightarrow \reff{\phi \supset \psi}$.
\item
$(\triplelambda e : x =_A y . P)_{MN} Q \rightarrow P [ x := M, y := N, e := Q ]$
\item
$\reff{M}_{N N'} P \rightarrow M \{ x:= P : N = N' \}$.
\item
If $P \rightarrow Q$ then $P^+ \rightarrow Q^+$ and $P^- \rightarrow Q^-$.
\item
If $P \rightarrow P'$ then $P_{MN} Q \rightarrow P'_{MN} Q$.
\end{itemize}
\end{definition}

Note that this relation is \emph{deterministic}: i.e. for any $E$, there is at most one $F$ such that $E \rightarrow F$.

\begin{lemma}[Head reduction respects path substitution]
If $M \rightarrow N$ then $M \{ \tau : \rho = \sigma \} \rightarrow N \{ \tau : \rho = \sigma \}$.
\end{lemma}

\begin{proof}
Induction on $M \rightarrow N$.  The only difficult case is $\beta$-reduction.  We have
\begin{align*}
& ((\lambda x:A.M)N)\{ \tau : \rho = \sigma \} \\
\equiv & (\triplelambda e : x =_A x' . M \{ \tau : \rho = \sigma, x := e : x = x' \})_{N [ \rho ] N [ \sigma ]} N \{ \tau : \rho = \sigma \} \\
\rightarrow & M \{ \tau : \rho = \sigma, x := N \{ \tau \} : N [ \rho ] = N [ \sigma ] \} \\
\equiv & M [ x := N ] \{ \tau : \rho = \sigma \} & (\text{Lemma \ref{lm:pathsubsub}})
\end{align*}
\end{proof}

\begin{lemma}
\label{lm:compat-beta}
Suppose $\phi$ reduces to a canonical proposition $\phi'$, and $\phi \simeq_\beta \psi$.  Then $\psi$ reduces to $\phi'$.
\end{lemma}

\begin{proof}
Note that on terms, our head reduction is $\beta$-reduction; that is, if $\phi$ reduces to $\phi'$, then $\phi \twoheadrightarrow_\beta \phi'$.
The result follows from the Church-Rosser theorem for $\beta$-reduction, and the fact that every canonical proposition is a $\beta$-normal form.
\end{proof}

\subsection{Neutral Expressions}

\begin{definition}[Neutral]$ $
\begin{itemize}
\item
A \emph{neutral} term is one of the form $x M_1 \cdots M_n$.
\item
A \emph{neutral} path is one of the form $e_{M_1 N_1} P_1 \cdots_{M_n N_n} P_n$.
\item
A \emph{neutral} proof is either one of the form $p \delta_1 \cdots \delta_n$, or of the form $P^+ \delta_1 \cdots \delta_n$ or
$P^- \delta_1 \cdots \delta_n$ where $P$ is a neutral path.
\end{itemize}
\end{definition}

\begin{lemma}
A term in head normal form is either a neutral term, a canonical proposition, or a $\lambda$-term.
\end{lemma}

\begin{proof}
An easy proof by case analysis.
\end{proof}

\section{Example}

Using univalence, we can construct a path of type $\top = \top \rightarrow \top$, and thence a proof of $\top \rightarrow \top \rightarrow \top$.
But which of the canonical proofs of $\top \rightarrow \top \rightarrow \top$ have we constructed?


We define
\[ \top := \bot \rightarrow \bot, \quad I_\bot := \lambda p:\bot.p, \quad I_\Omega := \lambda x:\Omega.x, \quad F := \lambda x:\Omega.\top \rightarrow x, \quad H := \lambda h.h \top \enspace . \]

Now, we have
\begin{align*}
x : \Omega, y : \Omega, e : x =_\Omega y & \vdash \lambda p:\top \rightarrow x. e^+ (p I) & : (\top \rightarrow x) \rightarrow y \\
x : \Omega, y : \Omega, e : x =_\Omega y & \vdash \lambda m : y. \lambda n : \top. e^- m & : y \rightarrow \top \rightarrow x \\
x : \Omega, y : \Omega, e : x =_\Omega y & \vdash \univ*{\lambda p:\top \rightarrow x. e^- m}{\lambda m:y. \lambda n:\top. e^- m} & : \top \rightarrow x =_\Omega y
\end{align*}

Let $P \equiv \univ*{\lambda p:\top \rightarrow x. e^+ (pI)}{\lambda m:y. \lambda n:\top. e^- m}$.  Then

\begin{align*}
\therefore & \vdash \triplelambda e:x =_\Omega y. P & : F =_{\Omega \rightarrow \Omega} I_\Omega \\
\therefore & (\reff{H})_{FI}(\triplelambda e:x =_\Omega y. P) & : \top \rightarrow \top =_\Omega \top \\
\therefore & ((\reff{H})_{FI}(\triplelambda e:x =_\Omega y.P))^- & : \top \rightarrow \top \rightarrow \top
\end{align*}

And now we compute:

\begin{align*}
((\reff{H})_{FI}(\triplelambda e:x =_\Omega y.P))^-
& \rightarrow ((h \top) \{ h := \triplelambda e : x =_\Omega y.P : F = I \})^- \\
& \equiv ((\triplelambda e : x =_\Omega y.P)_{\top \top} (\reff{\top}))^- \\
& \rightarrow (P [ x := \top, y := \top, e := \reff{\top} ])^- \\
& \equiv \univ*{\lambda p : \top \rightarrow \top. \reff{\top}^+ (p I)}{\lambda m:\top. \lambda n:\top. \reff{\top}^- m}^- \\
& \rightarrow \univ*{\lambda p:\top \rightarrow \top. (\lambda q:\top.q)(p I)}{\lambda m:\top. \lambda n:\top. (\lambda q:\top.q) m}^- \\
& \rightarrow \univ*{\lambda p:\top \rightarrow \top. pI}{\lambda m:\top. \lambda n:\top. m}^- \\
& \rightarrow \lambda m:\top. \lambda n:\top. n
\end{align*}

\subsection{Comparison with Cubical Type Theory}

In cubical type theory, let $\bot$ be any type in $U$ (possibly the empty type, but we do not require this in what follows).  Define
\[ \top := \bot \rightarrow \bot, \quad I_\bot := \lambda p:\bot.p, \quad I_U := \lambda x:U.x, \quad F := \lambda x:U.\top \rightarrow x, \quad H := \lambda h.h \top \enspace . \]
Then we have
\begin{align*}
& \vdash \top & : U \\
& \vdash I_\bot & : \bot \rightarrow \bot \\
& \vdash I_U & : U \rightarrow U \\
& \vdash F & : U \rightarrow U \\
& \vdash H & : (U \rightarrow U) \rightarrow U
\end{align*}

In cubical type theory, let $\bot$ be any type in $U$ (possibly the empty type, but we do not require this in what follows).  Define
\[ \top := \bot \rightarrow \bot, \quad I_\bot := \lambda p:\bot.p, \quad I_U := \lambda x:U.x, \quad F := \lambda x:U.\top \rightarrow x, \quad H := \lambda h.h \top \enspace . \]
Then we have
\begin{align*}
& \vdash \top & : U \\
& \vdash I_\bot & : \bot \rightarrow \bot \\
& \vdash I_U & : U \rightarrow U \\
& \vdash F & : U \rightarrow U \\
& \vdash H & : (U \rightarrow U) \rightarrow U
\end{align*}

We can prove the type $\Sigma f:\top \rightarrow X. Path \, X \, x \, (f I)$ in contractible (we omit the details).  Let $e[X, x, p]$ be the term such that
\begin{align*} & X : U, x : X, p : \Sigma f:\top \rightarrow X. \Path{X}{x}{(fI)} \\
\vdash & e[X, x, p] : \Path{(\Sigma f:\top \rightarrow X. \Path{X}{x}{(f I)})}{\langle \lambda t : \top . x, 1_x \rangle}{p}
\end{align*}

Let
\[ step2[X,x] \equiv \langle \langle \lambda t : T.x, 1_x \rangle,
\lambda p : \Sigma f : T \rightarrow X. \Path{X}{x}{(fI)}. e[X, x, p] \rangle \]
Then
\[ X : U, x : X \vdash step2[X, x] : isContr(\Sigma f:T \rightarrow X. \Path{X}{x}{(fI)}) \]

Let
\[ step3[X] \equiv \lambda x : X. step2[X, x] \]
Then
\[X : U \vdash step3[X] : isEquiv \, (T \rightarrow X) \, X \, (\lambda f : T \rightarrow X. f I) \]

Let
\[ E[X] \equiv \langle \lambda f : \top \rightarrow X. f I, step3[X] \rangle \]
Then
\[ X : U \vdash E[X] : Equiv \, (\top \rightarrow X) \, X \]

From this equivalence, we want to get a path from $\top \rightarrow X$ to $X$ in $U$.  We apply the proof of univalence in \cite{cchm:cubical}

Let
\[ P[X] \equiv \langle i \rangle Glue [(i = 0) \mapsto (\top \rightarrow X, E[X]), (i = 1) \mapsto (X, equiv^k X)] X \]
Then
\[ X : U \vdash P[X] : \Path{U}{(\top \rightarrow X)}{X} \]

Let
\[ P_2 \equiv \langle i \rangle \lambda x : U. P[X] i \]
Then
\[ \vdash P_2 : \Path{(U \rightarrow U)}{F}{I} \]
\[ \vdash \langle i \rangle H (P_2 i) : \Path{(U \rightarrow U)}{\top \rightarrow \top}{\top} \]
\[ \vdash \langle i \rangle H (P_2 (1 - i)) : \Path{(U \rightarrow U)}{\top}{\top \rightarrow \top} \]

Now we apply transport to this term:
\[ \vdash \lambda x : \top. comp^i (H (P_2 (1 - i))) [] x : \top \rightarrow \top \rightarrow \top \]
and we calculate:
\begin{align*}
output & \equiv \lambda x : \top. comp^i (H (P_2 (1 - i))) [] x
& = \lambda x : \top. comp^i (P_2 (1 - i) \top) [] x \\
& = \lambda x : \top. comp^i (P[\top] (1 - i)) [] x \\
& = \lambda x : \top. comp^i (Glue[(i = 1) \mapsto (\top \rightarrow \top, E[\top]), (i = 0) \mapsto (\top, equiv^k \top)] \top) [] x \\
& = \lambda x : \top. glue [ 1_\mathbb{F} \mapsto t_1 ] a_1 \\
\end{align*}

(using the notation from \cite{cchm:cubical} section 6.2)

\begin{align*}
& = \lambda x : \top. t_1
& = \lambda x : \top. (equiv \, E[\top] \, [] \, mapid_\top(x)).1 \\
& = \lambda x : \top. (contr (step2[\top, mapid_\top(x)]) []).1 \\
& = \lambda x : \top. (comp^i (\Sigma f : \top \rightarrow \top. \Path{\top}{mapid_\top(x)}{(fI)}) [] \langle \lambda t : \top. mapid_\top(x), 1_{mapid_\top(x)} \rangle).1 \\
& = \lambda x : \top. mapid_{\top \rightarrow \top}(\lambda _ : \top. mapid_\top(x)) \\
\therefore output \, m \, n & = mapid_{\top \rightarrow \top}(\lambda _ : \top. mapid_\top(m)) n \\
& \equiv (comp^i (\top \rightarrow \top) [] (\lambda _ : \top. mapid_\top(m))) n \\
& = mapid_\top(mapid_\top(m))
\end{align*}

This term does not compute any farther.

If we add to cubical type theory the rule $mapid_A(t) = t$, then we have that $output$ reduces to $\lambda m : \top. \lambda n : \top. m$ as in $\lambda o e$.

In the reduction relation given in `Canonicity for Cubical Type Theory', we have
\[ mapid_{\bot \rightarrow \bot}(m) \succ \lambda x : \bot. mapid_\bot(m mapid_\bot(x)) \]
and so if we add $mapid_\bot(t) \succ t$ we obtain $output \succ \lambda mn.m$.

\section{Computable Expressions}

\begin{definition}[Computable Expression]
We define the relation $\models E : T$, read '$E$ is a computable expression of type $T$', as follows.
\begin{itemize}
\item
$\models M : A$ iff $\models M \{\} : M =_A M$.
\item
$\models \delta : \bot$ iff $\delta$ reduces to a neutral proof.
\item
For $\phi$ and $\psi$ canonical propositions, $\models \delta : \phi \supset \psi$ iff, for all $\epsilon$ such that $\models \epsilon : \phi$, we have $\models \delta \epsilon : \psi$.
\item
If $\phi$ reduces to the canonical proposition $\psi$, then $\models \delta : \phi$ iff $\models \delta : \psi$.
\item
$\models P : \phi =_\Omega \psi$ iff $\models P^+ : \phi \supset \psi$ and $\models P^- : \psi \supset \phi$.
\item
$\models P : M =_{A \rightarrow B} M'$ iff, for all $Q$, $N$, $N'$ such that $\models N : A$ and $\models N' : A$ and $\models Q : N =_A N'$, then we have $\models P_{NN'}Q : MN =_B M'N'$.
\end{itemize}
\end{definition}

\begin{definition}[Computable Substitution]
Let $\sigma$ be a substitution with domain $\dom \Gamma$.  We write $\models \sigma : \Gamma$ and say that
$\sigma$ is a \emph{computable} substitution on $\Gamma$ iff, for every entry $z : T$ in $\Gamma$, we have $\models \sigma(z) : T [ \sigma ]$.

We write $\models \tau : \rho = \sigma : \Gamma $, and say $\tau$ is a \emph{computable} path substitution between $\rho$ and $\sigma$, iff, for every term variable entry $x : A$ in $\Gamma$, we have $\models \tau(x) : \rho(x) =_A \sigma(x)$.
\end{definition}

\begin{lemma}
\label{lm:conv-compute}
If $\models E : S$ and $S \simeq_\beta T$ then $\models E : T$.
\end{lemma}

\begin{proof}
This follows easily from the definition and Lemma \ref{lm:compat-beta}.
\end{proof}

\begin{lemma}[Well-typed Expansion]
If $\models F : T$ and $E \rightarrow F$ then $\models E : T$.
\end{lemma}

\begin{proof}
An easy induction, using the fact that head reduction respects path substitution.
\end{proof}

\begin{lemma}[Reduction]
If $\models E : T$ and $E \rightarrow F$ then $\models F : T$.
\end{lemma}

\begin{proof}
An easy induction, using the fact that head reduction is deterministic.
\end{proof}

\begin{lemma}
If $\models E : T$ then $E$ head reduces to a head normal form.
\end{lemma}

\begin{proof}
Induction on $\models E : T$.
\end{proof}
%Note about Markov's principle?

\begin{lemma}
\label{lm:compute-lambda}
If $\models M : A \rightarrow B$ then $M$ head reduces to a $\lambda$-term.
\end{lemma}

\begin{proof}
We have that $M$ reduces to a head normal form $M'$, and $\Gamma \vdash M' : A \rightarrow B$ by Subject Reduction.
$M'$ cannot be a neutral term as $\Gamma$ has no term variables, and it cannot be $\bot$ or a $\supset$-term by Generation,
so it must be a $\lambda$-term.
\end{proof}

\begin{lemma}
\label{lm:ref-compute-Omega}
For any term $\phi$, we have $\models \reff{\phi} : \phi =_\Omega \phi$.
\end{lemma}

\begin{proof}
We must show that $\models \reff{\phi}^+ : \phi \supset \phi$ and $\models \reff{\phi}^- : \phi \supset \phi$.  So let $\models \delta : \phi$.
Then $\models \reff{\phi}^+ \delta : \phi$ and $\models \reff{\phi}^- \delta : \phi$ by well-typed expansion, as required.
\end{proof}

\begin{lemma}
$\models \phi : \Omega$ if and only if $\phi$ head reduces to a canonical proposition.
\end{lemma}

\begin{proof}
If $\models \phi : \Omega$ then $\models \phi \{\}^+ : \phi \supset \phi$.  Therefore $\phi \supset \phi$ reduces to a canonical proposition,
and so $\phi$ must reduce to a canonical proposition.

Conversely, suppose $\phi$ reduces to a canonical proposition $\phi'$.  We have $\phi \{\} \twoheadrightarrow \phi' \{\} \twoheadrightarrow \reff{\phi'}$, and so $\models \phi \{\} : \phi =_\Omega \phi$ by well-typed expansion.  Hence $\models \phi : \Omega$.
\end{proof}

\begin{lemma}
\label{lm:neutral-proof}
If $\delta$ is a neutral proof and $\phi$ head reduces to a canonical proposition, then $\models \delta : \phi$.
\end{lemma}

\begin{proof}
It is sufficient to prove the case where $\phi$ is a canonical proposition.  The proof is by induction on $\phi$.

If $\phi \equiv \bot$, then $\models \delta : \bot$ immediately from the definition.

If $\phi \equiv \psi \supset \chi$, then let $\models \epsilon : \psi$.  We have that $\delta \epsilon$ is neutral,
hence $\models \delta \epsilon : \chi$ by the induction hypothesis.
\end{proof}

\begin{lemma}
\label{lm:neutral-path}
Let $\models M : A$ and $\models N : A$.  If $P$ is a neutral path, then $\models P : M =_A N$.
\end{lemma}

\begin{proof}
The proof is by induction on $A$.

For $A \equiv \Omega$: we have that $P^+$ and $P^-$ are neutral proofs, and $M$ and $N$ head reduce to canonical propositions, so $\models P^+ : M \supset N$ and
$\models P^- : N \supset M$ by the previous lemma, as required.

For $A \equiv B \rightarrow C$: let $\models L : B$, $\models L' : B$ and $\models Q : L =_B L'$.  Then we have $\models ML : C$, $\models NL' : C$ and
$P_{LL'} Q$ is a neutral path, hence $\models P_{L L'} Q : ML =_C NL'$ as required.
\end{proof}

\begin{lemma}
\label{lm:ref-compute}
If $\models M : A$ then $\models \reff{M} : M =_A M$.
\end{lemma}

\begin{proof}
If $A \equiv \Omega$, this is just Lemma \ref{lm:ref-compute-Omega}.

So suppose $A \equiv B \rightarrow C$.  By Lemma \ref{lm:compute-lambda}, we have that $M \twoheadrightarrow \lambda x:A.M'$.  So by well-typed expansion, it is sufficient to prove that
\[ \models \reff{\lambda x:A.M'} : \lambda x:A.M' =_{B \rightarrow C} \lambda x:A.M' \enspace . \]
Let $\models P : N =_B N'$.  We must show that
\[ \models \reff{\lambda x:A.M'}_{N N'} P : M' [x:= N] =_C M' [x:=N'] \enspace . \]
By well-typed expansion, it is sufficient to prove
\[ \models M' \{ x:= P : N = N' \} : M' [x:=N] =_C M' [x:= N'] \enspace . \]
Now, we have that $\models M \{\} : M =_{B \rightarrow C} M$, and so
\[ \models \triplelambda e : x =_A x' . M' \{ x := e : x = x' \} : \lambda x:A.M' =_{B \rightarrow C} \lambda x:A.M' \enspace . \]
Therefore,
\[ \models (\triplelambda e : x=_A x' . M' \{ x := e : x = x' \})_{N N'} P : (\lambda x:A.M') N =_C (\lambda x:A.M') N' \enspace , \]
and the result follows by Reduction.
\end{proof}

\begin{lemma}
\label{lm:compute-supset*}
If $\models P : \phi =_\Omega \phi'$ and $\models Q : \psi =_\Omega \psi'$ then $\models  P \supset^* Q : \phi \supset \psi =_\Omega \phi' \supset \psi'$.
\end{lemma}

\begin{proof}
%WATCH
We have that $\phi \equiv \phi'$ and $\psi \equiv \psi'$.  Also, we have $P \twoheadrightarrow \reff{\phi}$ and $Q \twoheadrightarrow \reff{\psi}$, hence
$P \supset^* Q \twoheadrightarrow \reff{\phi} \supset^* \reff{\psi} \rightarrow \reff{\phi \supset \psi}$. %TODO univ
\end{proof}

\section{Proof of Canonicity}

\begin{theorem}
\begin{enumerate}
\item
If $\Gamma \vdash \mathcal{J}$ and $\models \sigma : \Gamma$, then $\models \mathcal{J} [ \sigma ]$.
\item
If $\Gamma \vdash M : A$ and $\models \tau : \rho = \sigma : \Gamma$, then $\models M \{ \tau : \rho = \sigma \} : M [ \rho ] =_A M [ \sigma ]$.
\end{enumerate}
\end{theorem}

\begin{proof}
The proof is by induction on derivations.
\begin{enumerate}
\item
For the (var) rules, the result is immediate from the hypothesis.  

The case ($\bot$) follows from Lemma \ref{lm:ref-compute-Omega}.

For the rule ($\supset$), we use Lemma \ref{lm:compute-supset*}.

The case (app$_T$) is trivial.

For the rule ($\lambda_T$), we must show that
\[ \Delta \models \lambda x:A.M[\sigma] : A \rightarrow B \enspace . \]
So let $\Delta \models N : A$.  Then the induction hypothesis gives
\[ \Delta \models M[\sigma, x:=N] : B \]
and so by well-typed expansion we have
\[ \Delta \models (\lambda x:A.M[\sigma])N : B \]
as required.

The case (app$_P$) is trivial.

The case ($\lambda_P$) is similar to ($\lambda_T$), also making use of Lemma \ref{lm:conv-compute}.

The case (conv$_P$) follows immediately from Lemma \ref{lm:conv-compute}.

The case (ref) is immediate from Lemma \ref{lm:ref-compute}.

The cases (plus) and (minus) are trivial.

For the rule ($\triplelambda$), let $\Delta \models Q : L =_A L'$.  Then the induction hypothesis gives
\[ \Delta \models P [ \sigma, x := L, y := L', e := Q ] : M [\sigma] L =_B N [\sigma] L' \]
and hence well-typed expansion gives
\[ \Delta \models (\triplelambda e:x =_A y.P [ \sigma ])_{L L'} Q : M[\sigma] L =_B N[\sigma] L' \]
as required.

The case (app$_E$) is trivial.  The case (conv$_E$) follows immediately from Lemma \ref{lm:conv-compute}.
\item
The case (var$_T$) is immediate from hypothesis.

The case ($\bot$) follows from Lemma \ref{lm:ref-compute-Omega}.

The case ($\supset$) follows from Lemma \ref{lm:compute-supset*}.

The case (app$_T$) is trivial.

For the case ($\lambda$), we must show that
\[ \Delta \models \triplelambda e : x =_A y. M \{ \tau : \rho = \sigma, x := e : x = y \} : \lambda x:A.M [ \rho ] =_{A \rightarrow B} \lambda x:A.M [ \sigma ] \enspace . \]
So let $\Delta \models P : N =_A N'$.  The induction hypothesis gives
\[ \Delta \models M \{ \tau : \rho = \sigma, x := P : N = N' \} : M [\rho, x := N] =_B M [\sigma, x := N'] \enspace , \]
and so we have
\[ \Delta \models (\triplelambda e : x =_A y. M \{ \tau : \rho = \sigma, x := e : x = y \})_{N N'} P : (\lambda x:A.M [ \rho ])N =_B (\lambda x:A.M [ \sigma ])N'\]
by well-typed expansion, as required.
\end{enumerate}
\end{proof}

\begin{corollary}
If $\Gamma \vdash E : T$ then $E$ head reduces to a head normal form.
\end{corollary}

\begin{proof}
Let $\mathrm{id}_\Gamma$ be the substitution on $\dom \Gamma$ that maps a variable to itself.
We prove that, if $\Gamma \vald$, then $\models \mathrm{id}_\Gamma : \Gamma$; the proof is by induction on derivations, and uses Lemmas \ref{lm:neutral-proof} and \ref{lm:neutral-path}.
\end{proof}

\begin{corollary}[Canonicity]
If $\vdash E : T$ then $E$ head reduces to a canonical form.
\end{corollary}

\section{Conclusion}

\bibliography{../../../../type}

\end{document}
